<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Sharkord — Hotkey Picker</title>
		<link rel="stylesheet" href="assets/style.css" />
	</head>
	<body>
		<div class="container">
			<div class="card" role="main">
				<h1>Hotkeys</h1>
				<p class="lead">Choose one hotkey for mute and one for deafen.</p>

				<div class="row hotkey-row" data-kind="mute">
					<div>
						<label class="label" for="muteHotkey">Mute hotkey</label>
						<input id="muteHotkey" class="hotkey-input" type="text" placeholder="Not set" readonly />
					</div>
					<button id="captureMute" class="btn capture" type="button">Set</button>
				</div>

				<div class="row hotkey-row" data-kind="deafen">
					<div>
						<label class="label" for="deafenHotkey">Deafen hotkey</label>
						<input id="deafenHotkey" class="hotkey-input" type="text" placeholder="Not set" readonly />
					</div>
					<button id="captureDeafen" class="btn capture" type="button">Set</button>
				</div>

				<div class="actions">
					<button id="saveBtn" class="btn primary" type="button">Save</button>
					<button id="clearBtn" class="btn" type="button">Clear</button>
				</div>

				<div id="status" class="status" aria-live="polite"></div>
				<div class="hint">Press a key combination like Ctrl+Shift+M. Single modifier keys are not allowed.</div>
			</div>
		</div>

		<script>
			const muteInput = document.getElementById('muteHotkey');
			const deafenInput = document.getElementById('deafenHotkey');
			const captureMuteBtn = document.getElementById('captureMute');
			const captureDeafenBtn = document.getElementById('captureDeafen');
			const saveBtn = document.getElementById('saveBtn');
			const clearBtn = document.getElementById('clearBtn');
			const statusEl = document.getElementById('status');

			const STORAGE_KEYS = {
				mute: 'sharkord_hotkey_mute',
				deafen: 'sharkord_hotkey_deafen'
			};

			let captureTarget = null;
			let muteValue = '';
			let deafenValue = '';
			let toastTimer = null;

			function setStatus(message, isError = false) {
				statusEl.textContent = message;
				statusEl.classList.toggle('error', !!isError);
			}

			function showToast(message) {
				let toastEl = document.getElementById('hotkeyToast');
				if (!toastEl) {
					toastEl = document.createElement('div');
					toastEl.id = 'hotkeyToast';
					toastEl.className = 'toast';
					document.body.appendChild(toastEl);
				}

				toastEl.textContent = message;
				toastEl.classList.add('show');

				if (toastTimer) clearTimeout(toastTimer);
				toastTimer = setTimeout(() => {
					toastEl.classList.remove('show');
				}, 2400);
			}

			function normalizeKeyName(key) {
				if (!key) return '';
				if (key === ' ') return 'Space';
				if (key.length === 1) return key.toUpperCase();
				const mapping = {
					Control: 'Ctrl',
					Escape: 'Esc',
					ArrowUp: 'Up',
					ArrowDown: 'Down',
					ArrowLeft: 'Left',
					ArrowRight: 'Right'
				};
				return mapping[key] || key;
			}

			function isModifierOnly(key) {
				return ['Shift', 'Control', 'Alt', 'Meta'].includes(key);
			}

			function buildHotkeyFromEvent(e) {
				const parts = [];
				if (e.ctrlKey) parts.push('Ctrl');
				if (e.altKey) parts.push('Alt');
				if (e.shiftKey) parts.push('Shift');
				if (e.metaKey) parts.push('Meta');

				const key = normalizeKeyName(e.key);
				if (!key || isModifierOnly(e.key)) return '';
				parts.push(key);
				return parts.join('+');
			}

			function setCaptureMode(kind, enabled) {
				const input = kind === 'mute' ? muteInput : deafenInput;
				const button = kind === 'mute' ? captureMuteBtn : captureDeafenBtn;

				input.classList.toggle('recording', enabled);
				button.classList.toggle('recording', enabled);
				button.textContent = enabled ? 'Press keys…' : 'Set';
			}

			function startCapture(kind) {
				if (captureTarget && captureTarget !== kind) setCaptureMode(captureTarget, false);
				captureTarget = kind;
				setCaptureMode(kind, true);
				setStatus('Recording ' + kind + ' hotkey...');
			}

			function stopCapture() {
				if (!captureTarget) return;
				setCaptureMode(captureTarget, false);
				captureTarget = null;
			}

			function loadFromStorage() {
				try {
					muteValue = localStorage.getItem(STORAGE_KEYS.mute) || '';
					deafenValue = localStorage.getItem(STORAGE_KEYS.deafen) || '';
				} catch (err) {
					setStatus('Could not read saved hotkeys.', true);
				}
				muteInput.value = muteValue;
				deafenInput.value = deafenValue;
			}

			async function applyHotkeysWithIPC() {
				let success = false;
				if (!window.electronAPI) return true;
				if (typeof window.electronAPI.unregisterAllGlobalShortcuts === 'function') {
					await window.electronAPI.unregisterAllGlobalShortcuts();
				}
				if (muteValue && typeof window.electronAPI.registerGlobalShortcut === 'function') {
					success = await window.electronAPI.registerGlobalShortcut(muteValue, { key: 'm', keyCode: 'M', modifiers: ['control'] });
				}
				if (deafenValue && typeof window.electronAPI.registerGlobalShortcut === 'function' && success) {
					success = await window.electronAPI.registerGlobalShortcut(deafenValue, { key: 'd', keyCode: 'D', modifiers: ['control'] });
				}
				if (!success) {
					showToast('Hotkey registration failed');
				}
				return success;
			}

			captureMuteBtn.addEventListener('click', () => startCapture('mute'));
			captureDeafenBtn.addEventListener('click', () => startCapture('deafen'));

			window.addEventListener('keydown', (e) => {
				if (!captureTarget) return;
				e.preventDefault();

				if (e.key === 'Escape') {
					stopCapture();
					setStatus('Capture canceled.');
					return;
				}

				const combo = buildHotkeyFromEvent(e);
				if (!combo) return;

				if (captureTarget === 'mute') {
					muteValue = combo;
					muteInput.value = combo;
				} else {
					deafenValue = combo;
					deafenInput.value = combo;
				}

				stopCapture();
				setStatus('Captured: ' + combo);
			});

			saveBtn.addEventListener('click', async () => {
				if (muteValue === deafenValue) {
					setStatus('Mute and deafen hotkeys must be different.', true);
					return;
				}

				try {
					localStorage.setItem(STORAGE_KEYS.mute, muteValue);
					localStorage.setItem(STORAGE_KEYS.deafen, deafenValue);
					if (window.electronAPI && typeof window.electronAPI.persistHotkeys === 'function') {
						window.electronAPI.persistHotkeys(muteValue, deafenValue);
					}
					const applied = await applyHotkeysWithIPC();
					if (!applied) {
						setStatus('Failed to save hotkeys.', true);
						return;
					}
					setStatus('Hotkeys saved.');
				} catch (err) {
					console.error(err);
					setStatus('Failed to save hotkeys.', true);
				}
			});

			clearBtn.addEventListener('click', async () => {
				stopCapture();
				muteValue = '';
				deafenValue = '';
				muteInput.value = '';
				deafenInput.value = '';
				try {
					localStorage.removeItem(STORAGE_KEYS.mute);
					localStorage.removeItem(STORAGE_KEYS.deafen);
					if (window.electronAPI && typeof window.electronAPI.unregisterAllGlobalShortcuts === 'function') {
						await window.electronAPI.unregisterAllGlobalShortcuts();
					}
					setStatus('Hotkeys cleared.');
				} catch (err) {
					console.error(err);
					setStatus('Failed to clear hotkeys.', true);
				}
			});

			loadFromStorage();
		</script>
	</body>
</html>
