<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'unsafe-inline'"> 
    <title>Select screen or window</title>
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body class="align-top" data-accent="mint">
    <div class="container wide" role="dialog" aria-labelledby="title">
      <header>
        <div>
          <h1 id="title" class="title-sm">Share your screen</h1>
          <p class="lead">Choose a window or screen to share (click to select)</p>
          <div class="form-row" style="margin-top:8px;">
            <label for="audioSelect">Capture audio from</label>
            <select id="audioSelect" class="input" aria-label="Select application audio source">
              <option value="">No app audio</option>
            </select>
          </div>
        </div>
        <div>
          <button id="cancelBtn" class="btn ghost">Cancel</button>
        </div>
      </header>

      <div id="grid" aria-live="polite"></div>
    </div>

    <script>
      const grid = document.getElementById('grid');
      const cancelBtn = document.getElementById('cancelBtn');
      const audioSelect = document.getElementById('audioSelect');

      function makeTile(s){
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.tabIndex = 0;
        tile.title = s.name;

        const wrap = document.createElement('div');
        wrap.className = 'thumb-wrap';
        const img = document.createElement('img');
        img.className = 'thumb';
        img.alt = s.name;
        img.src = s.thumbnailDataUrl || '';
        wrap.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = s.name;
        meta.appendChild(name);

        tile.appendChild(wrap);
        tile.appendChild(meta);

        const selectAudioProcess = () => window.chooserAPI.select(s.id, audioSelect?.value || '');

        tile.addEventListener('click', selectAudioProcess);
        tile.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectAudioProcess(); } });

        return tile;
      }

      window.chooserAPI.onSources((sources, processes = []) => {
        grid.innerHTML = '';
        sources.forEach(s => {
          grid.appendChild(makeTile(s));
        });

        audioSelect.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'No app audio';
        audioSelect.appendChild(none);

        processes.forEach((p) => {
          const opt = document.createElement('option');
          opt.value = p.processId;
          opt.textContent = `${p.title || 'Unknown'} (PID ${p.processId})`;
          audioSelect.appendChild(opt);
        });
      });

      cancelBtn.addEventListener('click', () => { window.chooserAPI.cancel(); });
    </script>
  </body>
</html>
